name: Auto Update Fiqh Rulings

on:
  # Run automatically once per month
  schedule:
    # At 03:00 UTC on the 1st day of every month
    - cron: "0 3 1 * *"

  # Allow manual runs from GitHub UI
  workflow_dispatch:

# REQUIRED for push access
permissions:
  contents: write

jobs:
  update-fiqh:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # 1️⃣ Checkout repository
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      # -------------------------------------------------
      # 2️⃣ Setup Node.js
      # -------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # -------------------------------------------------
      # 3️⃣ Install dependencies (if any)
      # -------------------------------------------------
      # If your scraper uses packages, keep this
      # If not, this step is harmless
      - name: Install dependencies
        run: npm install
        continue-on-error: true

      # -------------------------------------------------
      # 4️⃣ Run scraper / updater
      # -------------------------------------------------
      - name: Run Fiqh scraper
        run: node scripts/update-fiqh.js

      # -------------------------------------------------
      # 5️⃣ Commit and push changes (ONLY if changed)
      # -------------------------------------------------
      - name: Commit updated fiqh data
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git status

          git add data/fiqh_master.json

          # Exit cleanly if nothing changed
          if git diff --cached --quiet; then
            echo "No fiqh updates detected"
            exit 0
          fi

          git commit -m "Auto-update fiqh rulings (monthly)"
          git push
