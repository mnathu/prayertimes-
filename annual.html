<!DOCTYPE html>
<html>
<head>
	<title> Yearly Prayer Timetable </title>
	<style>
		body, form {font-family: tahoma; font-size: 12px; color: #404040; text-align: center; margin: 0; padding: 0}
		pre {font-family: courier, serif, size: 10pt; margin: 0px auto;}
		.header {background:#ffe6e6; border-bottom: 1px solid #ddd; padding: 7px;}
	</style>
</head>

<body>
<nav style="background:#0A166C; color:white; padding:10px; text-align:center;">
  <a href="index.html" style="color:white; margin:0 10px; text-decoration:none;">Home</a>
  <a href="annual.html" style="color:white; margin:0 10px; text-decoration:none;">Annual Timetable</a>
</nav>
<script type="text/javascript" src="PrayTimes.js"></script>

<div class="header">
<form class="form" action="javascript:update();">
	Latitude: <input type="text" value="45.0941" id="latitude" size="5" onchange="update();">&nbsp;
	Longitude: <input type="text" value="-93.3563" id="longitude" size="5" onchange="update();">&nbsp;
	Year: <input type="text" value="2011" id="year" size="4" onchange="update();">&nbsp;
	Time Zone: <input type="text" value="-6" id="timezone" size="2" onchange="update();">&nbsp;
	DST: 
	<select id="dst" size="1" style="font-size: 12px;" onchange="update()">
		<option value="auto" selected="selected">Auto</option>
		<option value="0">0</option>
		<option value="1">1</option>
    </select>&nbsp;
	Method: 
	<select id="method" size="1" style="font-size: 12px;" onchange="update()">
		<option value="Jafari" selected="selected">Leva Research Institute, Qum</option>
		<option value="Tehran">Institute of Geophysics, University of Tehran</option>
		<option value="MWL">Muslim World League (MWL)</option>
		<option value="ISNA">Islamic Society of North America (ISNA)</option>
		<option value="Egypt">Egyptian General Authority of Survey</option>
		<option value="Makkah">Umm al-Qura University, Makkah</option>
		<option value="Karachi">University of Islamic Sciences, Karachi</option>
	</select>
	<button onclick="window.print()">Print this page</button>
</form>
</div>
<br/>

<pre>
 Date  Imsak   Fajr   Sunrise  Dhuhr  Sunset  Maghrib   
----------------------------------------------------------
</pre>

<div id="timetable">
</div>
<br/>

<div align="center" style="margin-top: 7px">
	Powered by: <a href="http://praytimes.org/">PrayTimes.org</a>
</div>
<br/>

<script type="text/javascript">

	var date = new Date();
	$('year').value = date.getFullYear();
	update();

	function update() {
		var lat = $('latitude').value;
		var lng = $('longitude').value;
		var timeZone = $('timezone').value;
		var dst = $('dst').value;
		var year = $('year').value;
		var method = $('method').value;
		var html = makeTable(method, year, lat, lng, timeZone, dst);
		$('timetable').innerHTML = '<pre>'+ html+ '</pre>';
	}


	function makeTable(method, year, lat, lng, timeZone, dst) {
		var table = ''; 
		var monthNames = new Array('Jan', 'Feb', 'Mar', 'Apr', 'May',
				'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec');
		var date = new Date(year, 0, 1);
		var endDate = new Date(1*year+ 1, 0, 1);
		prayTimes.setMethod(method);
		
		var output = ['Imsak', 'Fajr', 'Sunrise', 'Dhuhr', 'Sunset', 'Maghrib'];

		while (date < endDate) {
			prayTimes.adjust({highLats: 'AngleBased'} );
			var times = prayTimes.getTimes(date, [lat, lng], timeZone, dst, '12hNS');
			var day = date.getDate();
			day = (day <10) ? '0'+ day : day;
			table += monthNames[date.getMonth()]+ ' '+ day+ '\t';
			for (var i in output)
				table += times[output[i].toLowerCase()]+ '\t';
			table += '\n';
			date.setDate(date.getDate()+ 1);  // next day
		}
		return table;
	}

	function $(id) {
		return document.getElementById(id);
	}

  function exportCSV() {
  const text = $('timetable').innerText;
  const rows = text.trim().split('\n').map(line => line.split('\t'));
  const csv = rows.map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Prayer_Timetable_${$('year').value}.csv`;
  a.click();
}

function exportXLSX() {
  const text = $('timetable').innerText;
  const rows = text.trim().split('\n').map(line => line.split('\t'));
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Timetable");
  XLSX.writeFile(wb, `Prayer_Timetable_${$('year').value}.xlsx`);
}


// Init
window.onload = () => {
  $('year').value = new Date().getFullYear();
  loadPrefs();
  update();

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      $('latitude').value = pos.coords.latitude.toFixed(5);
      $('longitude').value = pos.coords.longitude.toFixed(5);
      update();
    });
  }
};
	
</script>

</body>
</html>
