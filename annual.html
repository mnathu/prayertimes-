<!DOCTYPE html>
<html>
<head>
    <title>Annual Prayer Timetable</title>
    <style>
        body, form { font-family: Tahoma, sans-serif; font-size: 12px; color: #404040; text-align: center; margin: 0; padding: 0; }
        pre { font-family: Courier, monospace; margin: 0 auto; text-align: left; white-space: pre; }
        .header { background: #ffe6e6; border-bottom: 1px solid #ddd; padding: 10px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; }
        .btn { font-size: 12px; padding: 2px 8px; margin-left: 5px; }
        .location-display { margin-top: 10px; font-weight: bold; }

        @media print {
            .header, .buttons, .location-display, a { display: none; }
            pre { font-size: 10px; }
        }
    </style>
    <script src="PrayTimes.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>

<div class="header">
    Latitude: <input type="text" id="latitude" size="6" onchange="update();">
    Longitude: <input type="text" id="longitude" size="6" onchange="update();">
    Year: <input type="text" id="year" size="4" onchange="update();">
    Time Zone: <input type="text" id="timezone" size="3" readonly>
    Method:
    <select id="method" onchange="update();" style="font-size: 12px;">
        <option value="Jafari">Leva Research Institute (Jafari)</option>
        <option value="Tehran">University of Tehran</option>
        <option value="MWL">Muslim World League</option>
        <option value="ISNA">Islamic Society of North America</option>
        <option value="Egypt">Egyptian General Survey</option>
        <option value="Makkah">Umm al-Qura University</option>
        <option value="Karachi">University of Islamic Sciences, Karachi</option>
    </select>
    <span class="buttons">
        <button class="btn" onclick="window.print()">ðŸ–¨ Print</button>
        <button class="btn" onclick="downloadCSV()">CSV</button>
        <button class="btn" onclick="downloadXLSX()">XLSX</button>
    </span>
</div>

<div class="location-display" id="locationLabel">Location: Detecting...</div>

<pre>
 Date   Imsak   Fajr   Sunrise   Dhuhr   [Asr]   Sunset   Maghrib   [Isha]
--------------------------------------------------------------------------
</pre>

<div id="timetable"></div>

<br>
<div style="text-align: center;">
    Powered by: <a href="https://praytimes.org/">PrayTimes.org</a>
</div>
<br>

<script>
    const $ = id => document.getElementById(id);
    let visiblePrayers = [];
    let currentCSV = '';
    let currentXLSXData = [];

    // Init
    $('year').value = new Date().getFullYear();
    const storedMethod = localStorage.getItem('method');
    if (storedMethod) $('method').value = storedMethod;

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude.toFixed(4);
            const lon = pos.coords.longitude.toFixed(4);
            $('latitude').value = lat;
            $('longitude').value = lon;
            resolveLocation(lat, lon);
            update();
        }, () => {
            useDefaultLocation();
        });
    } else {
        useDefaultLocation();
    }

    function useDefaultLocation() {
        $('latitude').value = "45.0000";
        $('longitude').value = "-93.2500";
        $('locationLabel').innerText = "Location: Minneapolis, MN (Default)";
        update();
    }

    function resolveLocation(lat, lon) {
        // Try to get city and region using Intl if available
        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
            .then(res => res.json())
            .then(data => {
                const city = data.address.city || data.address.town || data.address.village || '';
                const state = data.address.state || '';
                $('locationLabel').innerText = `Location: ${city}, ${state}`;
            })
            .catch(() => {
                $('locationLabel').innerText = "Location: Unknown";
            });
    }

    function update() {
        const lat = parseFloat($('latitude').value);
        const lng = parseFloat($('longitude').value);
        const year = parseInt($('year').value);
        const method = $('method').value;

        localStorage.setItem('method', method);

        const midYear = new Date(year, 6, 1);
        const tzOffset = -midYear.getTimezoneOffset() / 60;
        $('timezone').value = tzOffset;

        const result = makeTable(method, year, lat, lng, tzOffset);
        $('timetable').innerHTML = '<pre>' + result.text + '</pre>';
        currentCSV = result.csv;
        currentXLSXData = result.xlsx;

        // Init
$('year').value = new Date().getFullYear();
const storedMethod = localStorage.getItem('method');
if (storedMethod) $('method').value = storedMethod;

// Restore location or use geolocation
const storedLat = localStorage.getItem('latitude');
const storedLng = localStorage.getItem('longitude');

if (storedLat && storedLng) {
    $('latitude').value = storedLat;
    $('longitude').value = storedLng;
    resolveLocation(storedLat, storedLng);
    update();
} else if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(4);
        const lon = pos.coords.longitude.toFixed(4);
        $('latitude').value = lat;
        $('longitude').value = lon;
        resolveLocation(lat, lon);
        update();
    }, () => {
        useDefaultLocation();
    });
} else {
    useDefaultLocation();
}
    
    }

    function makeTable(method, year, lat, lng, tzOffset) {
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                            'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        prayTimes.setMethod(method);
        prayTimes.adjust({ highLats: 'AngleBased' });

        visiblePrayers = ['Imsak', 'Fajr', 'Sunrise', 'Dhuhr', 'Sunset', 'Maghrib'];
        if (method !== 'Jafari' && method !== 'Tehran') {
            visiblePrayers.splice(4, 0, 'Asr');
            visiblePrayers.push('Isha');
        }

        let text = 'Date\t' + visiblePrayers.join('\t') + '\n';
        text += '-'.repeat(8 * (visiblePrayers.length + 1)) + '\n';
        let csv = 'Date,' + visiblePrayers.join(',') + '\n';
        let xlsx = [['Date', ...visiblePrayers]];

        let date = new Date(year, 0, 1);
        const endDate = new Date(year + 1, 0, 1);

        while (date < endDate) {
            const times = prayTimes.getTimes(date, [lat, lng], tzOffset, 'auto', '12hNS');
            const dayStr = `${monthNames[date.getMonth()]} ${String(date.getDate()).padStart(2, '0')}`;

            text += dayStr + '\t';
            csv += `"${dayStr}",`;
            let row = [dayStr];

            for (const prayer of visiblePrayers) {
                const time = times[prayer.toLowerCase()];
                text += time + '\t';
                csv += `"${time}",`;
                row.push(time);
            }

            text += '\n';
            csv = csv.slice(0, -1) + '\n';
            xlsx.push(row);
            date.setDate(date.getDate() + 1);
        }

        return { text, csv, xlsx };
    }

    function downloadCSV() {
        const blob = new Blob([currentCSV], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Prayer_Timetable_${$('year').value}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function downloadXLSX() {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(currentXLSXData);
        XLSX.utils.book_append_sheet(wb, ws, 'Prayer Times');
        XLSX.writeFile(wb, `Prayer_Timetable_${$('year').value}.xlsx`);
    }
</script>

</body>
</html>
