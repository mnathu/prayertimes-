<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hilal Forecast â€“ PrayerTimes</title>

<meta http-equiv="Content-Security-Policy"
content="
default-src 'self';
script-src 'self' 'unsafe-inline';
style-src 'self' 'unsafe-inline';
img-src 'self' https://tile.openstreetmap.org https://*.tile.openstreetmap.org data:;
connect-src 'self' https://tile.openstreetmap.org https://*.tile.openstreetmap.org;
">

<link rel="stylesheet" href="css/leaflet.css">

<style>
body { margin:0; font-family:Arial; background:#f9f9f9; }
.container { max-width:1100px; margin:auto; padding:20px; }
.card { background:white; padding:20px; margin-top:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
#map { height:500px; width:100%; margin-top:20px; border-radius:8px; }
select, input, button { padding:8px; margin:5px 0; }
.verdict-good { color:green; font-weight:bold; }
.verdict-mid { color:orange; font-weight:bold; }
.verdict-bad { color:red; font-weight:bold; }
</style>
</head>

<body>

<div class="container">

<h2>Hilal Forecast</h2>

<div class="card">
<label for="dateInput">Select 29th Evening Date:</label><br>
<input type="date" id="dateInput">

<br>

<label for="fiqhMode">Fiqh Mode:</label><br>
<select id="fiqhMode">
<option value="sistani">Sistani (Shared Horizon)</option>
<option value="global">Global Sighting</option>
</select>
</div>

<div class="card">
<h3>Date Information</h3>
<div id="dateDisplay"></div>
</div>

<div class="card">
<h3>Visibility Result</h3>
<div id="result">Calculating...</div>
</div>

<div id="map"></div>

</div>

<script src="js/suncalc.js"></script>
<script src="js/leaflet.js"></script>

<script>

document.addEventListener("DOMContentLoaded", function(){

let map = L.map('map').setView([30, 20], 3);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 7
}).addTo(map);

let markerLayer = L.layerGroup().addTo(map);

/* ===============================
   AUTO-SET NEXT HIJRI 29TH
================================= */

function setNextHijri29th() {

    const today = new Date();

    const formatter = new Intl.DateTimeFormat('en-TN-u-ca-islamic', {
        day: 'numeric',
        month: 'numeric',
        year: 'numeric'
    });

    const parts = formatter.formatToParts(today);

    let hDay, hMonth, hYear;

    parts.forEach(p => {
        if (p.type === 'day') hDay = parseInt(p.value);
        if (p.type === 'month') hMonth = parseInt(p.value);
        if (p.type === 'year') hYear = parseInt(p.value);
    });

    if (hDay > 29) {
        hMonth += 1;
        if (hMonth > 12) {
            hMonth = 1;
            hYear += 1;
        }
    }

    let candidate = new Date(today);
    candidate.setHours(0,0,0,0);

    for (let i = 0; i < 60; i++) {

        const testParts = formatter.formatToParts(candidate);

        let testDay, testMonth, testYear;

        testParts.forEach(p => {
            if (p.type === 'day') testDay = parseInt(p.value);
            if (p.type === 'month') testMonth = parseInt(p.value);
            if (p.type === 'year') testYear = parseInt(p.value);
        });

        if (testDay === 29 && testMonth === hMonth && testYear === hYear) {
            const formatted = candidate.toISOString().split("T")[0];
            document.getElementById("dateInput").value = formatted;
            calculateHilal();
            return;
        }

        candidate.setDate(candidate.getDate() + 1);
    }
}

/* ===============================
   AUTO-RUN EVENTS
================================= */

document.getElementById("dateInput").addEventListener("change", calculateHilal);
document.getElementById("fiqhMode").addEventListener("change", calculateHilal);

/* ===============================
   HILAL CALCULATION ENGINE
================================= */
function updateHijriDisplay(dateValue){

    if(!dateValue) return;

    const date = new Date(dateValue);

    const hijriFormatter = new Intl.DateTimeFormat('en-TN-u-ca-islamic', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });

    const gregorianFormatter = new Intl.DateTimeFormat('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    const hijriDate = hijriFormatter.format(date);
    const gregorianDate = gregorianFormatter.format(date);

    document.getElementById("dateDisplay").innerHTML =
        "<strong>Gregorian:</strong> " + gregorianDate +
        "<br><strong>Hijri:</strong> " + hijriDate + " AH";
}
    
function calculateHilal(){

    markerLayer.clearLayers();

    const dateValue = document.getElementById("dateInput").value;
    const fiqhMode = document.getElementById("fiqhMode").value;

    updateHijriDisplay(dateValue);
    if(!dateValue) return;

    const date = new Date(dateValue);
    let visibleZones = [];

    for(let lat = -40; lat <= 40; lat += 10){
        for(let lon = -120; lon <= 120; lon += 20){

            const times = SunCalc.getTimes(date, lat, lon);
            const sunset = times.sunset;
            if(!sunset) continue;

            const moonPos = SunCalc.getMoonPosition(sunset, lat, lon);
            const moonIllum = SunCalc.getMoonIllumination(sunset);

            const altitude = moonPos.altitude * (180/Math.PI);
            const elongation = moonIllum.phase * 360;

            let visibilityScore = altitude + elongation/10;

            let zoneType = "bad";

            if (visibilityScore > 15) {
                zoneType = "good";
            } else if (visibilityScore > 8) {
                zoneType = "mid";
            }

            let color = zoneType === "good" ? "green" :
                        zoneType === "mid" ? "orange" : "red";

            if (zoneType !== "bad") {
                visibleZones.push({lat, lon});
            }

            L.circle([lat, lon], {
                radius: 250000,
                color: color,
                fillColor: color,
                fillOpacity: 0.25,
                weight: 1
            }).addTo(markerLayer);
        }
    }

    determineMonthStart(visibleZones, fiqhMode);
}

/* ===============================
   MONTH START LOGIC
================================= */

function determineMonthStart(visibleZones, fiqhMode){

    const resultDiv = document.getElementById("result");

    if(visibleZones.length === 0){
        resultDiv.innerHTML =
        "<span class='verdict-bad'>Moon NOT visible on 29th evening. Month completes 30 days.</span>";
        return;
    }

    if(fiqhMode === "global"){
        resultDiv.innerHTML =
        "<span class='verdict-good'>Moon visible somewhere. New month starts next day (Global).</span>";
        return;
    }

    const referenceLat = 44.98;
    let shared = visibleZones.some(z => Math.abs(z.lat - referenceLat) <= 15);

    if(shared){
        resultDiv.innerHTML =
        "<span class='verdict-good'>Moon visible in shared horizon zone. New month begins.</span>";
    } else {
        resultDiv.innerHTML =
        "<span class='verdict-mid'>Moon visible but NOT in shared horizon. Month completes 30 days.</span>";
    }
}

/* ===============================
   INITIALIZE
================================= */

setNextHijri29th();

});

</script>

</body>
</html>
