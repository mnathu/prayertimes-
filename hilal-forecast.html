<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hilal Forecast Map</title>

<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial; background:#f4f4f4; }
h2 { text-align:center; margin:15px 0; }
#map { height:80vh; width:100%; }
.controls { text-align:center; margin:10px; }
.legend { text-align:center; margin-top:10px; font-weight:bold; }
a { text-decoration:none; color:#0066cc; }
</style>
</head>
<body>

<h2>Hilal Visibility Forecast (Unified Engine)</h2>

<div class="controls">
<input type="date" id="datePicker">
<br><br>
<a href="hilal-cities.html">View Cities Table â†’</a>
</div>

<div id="map"></div>

<div class="legend">
ðŸŸ¢ Easily Visible &nbsp; | &nbsp;
ðŸŸ¡ Optical Aid Likely &nbsp; | &nbsp;
ðŸ”´ Not Visible
</div>

<script>

// Default date = next 29th Hijri approximation
const today = new Date();
today.setDate(today.getDate()+29);
document.getElementById("datePicker").valueAsDate = today;

const map = L.map('map').setView([39,-98],4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
maxZoom:18
}).addTo(map);

// ===== TRUE ELONGATION =====
function getElongation(date, lat, lon){

    const sunPos = SunCalc.getPosition(date, lat, lon);
    const moonPos = SunCalc.getMoonPosition(date, lat, lon);

    const cosE =
        Math.sin(sunPos.altitude)*Math.sin(moonPos.altitude) +
        Math.cos(sunPos.altitude)*Math.cos(moonPos.altitude)*
        Math.cos(sunPos.azimuth - moonPos.azimuth);

    return Math.acos(cosE) * (180/Math.PI);
}

// ===== UNIFIED VISIBILITY ENGINE =====
function classifyVisibility(date, lat, lon){

    const times = SunCalc.getTimes(date, lat, lon);
    const sunset = times.sunset;
    if(!sunset) return null;

    const moonPos = SunCalc.getMoonPosition(sunset, lat, lon);
    const altitude = moonPos.altitude * 180/Math.PI;

    const elongation = getElongation(sunset, lat, lon);

    const q = altitude - (11 + 0.5 * elongation);

    if(q > 0.216){
        return { zone:"good", color:"green" };
    }
    else if(q > -0.160){
        return { zone:"mid", color:"orange" };
    }
    else{
        return { zone:"bad", color:"red" };
    }
}

// ===== DRAW MAP =====
function updateMap(){

    map.eachLayer(layer=>{
        if(layer instanceof L.CircleMarker) map.removeLayer(layer);
    });

    const date = new Date(document.getElementById("datePicker").value);

    for(let lat=25; lat<=55; lat+=3){
        for(let lon=-130; lon<=-60; lon+=3){

            const vis = classifyVisibility(date, lat, lon);
            if(!vis) continue;

            L.circleMarker([lat,lon],{
                radius:6,
                color:vis.color,
                fillOpacity:0.7
            }).addTo(map);
        }
    }
}

document.getElementById("datePicker").addEventListener("change",updateMap);
updateMap();

</script>

</body>
</html>
