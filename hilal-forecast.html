<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hilal Forecast | PrayerTimes</title>

<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; font-family:inherit; background:#f9f9f9; }

.container {
  max-width:1100px;
  margin:auto;
  padding:10px;
}

h2 {
  text-align:center;
  margin:10px 0;
}

.controls {
  text-align:center;
  margin-bottom:10px;
}

#map {
  width:100%;
  height:60vh;
  border-radius:8px;
}

@media (max-width:768px){
  #map { height:50vh; }
}

.advisory {
  margin-top:10px;
  padding:10px;
  background:white;
  border-radius:8px;
  font-size:0.95rem;
}
</style>
</head>
<body>

<div class="container">

<h2>Hilal Visibility Forecast</h2>

<div class="controls">
<input type="date" id="datePicker">
<div id="hijriDate"></div>
</div>

<div id="map"></div>

<div class="advisory" id="sistaniBox"></div>

</div>

<script>

// ===== Correct 29th Detection =====

function getNext29Hijri() {

    const today = new Date();

    for(let i=0;i<60;i++){

        let test = new Date();
        test.setDate(today.getDate()+i);

        const parts = new Intl.DateTimeFormat(
            'en-TN-u-ca-islamic',
            { day:'numeric' }
        ).formatToParts(test);

        const day = parts.find(p=>p.type==='day').value;

        if(day === "29") return test;
    }

    return today;
}

const defaultDate = getNext29Hijri();
document.getElementById("datePicker").valueAsDate = defaultDate;

// ===== Map Setup =====

const map = L.map('map').setView([39,-98],4);

L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{ maxZoom:18 }
).addTo(map);

// ===== Astronomy =====

function getElongation(date, lat, lon){

    const sun = SunCalc.getPosition(date, lat, lon);
    const moon = SunCalc.getMoonPosition(date, lat, lon);

    const cosE =
        Math.sin(sun.altitude)*Math.sin(moon.altitude) +
        Math.cos(sun.altitude)*Math.cos(moon.altitude)*
        Math.cos(sun.azimuth - moon.azimuth);

    return Math.acos(cosE) * (180/Math.PI);
}

function classify(date, lat, lon){

    const sunset = new Date(
        SunCalc.getTimes(date,lat,lon).sunset.getTime()+5*60000
    );

    const sun = SunCalc.getPosition(sunset, lat, lon);
    const moon = SunCalc.getMoonPosition(sunset, lat, lon);

    const moonAlt = moon.altitude*180/Math.PI;
    const sunAlt = sun.altitude*180/Math.PI;
    const elong = getElongation(sunset,lat,lon);

    const arcv = moonAlt - sunAlt;
    const q = arcv - (0.1018*elong*elong - 1.162*elong + 6.322);

    if(q > 0.216) return {zone:"A",color:"green"};
    if(q > -0.014) return {zone:"B",color:"limegreen"};
    if(q > -0.160) return {zone:"C",color:"orange"};
    if(q > -0.232) return {zone:"D",color:"darkorange"};
    return {zone:"E",color:"red"};
}

function update(){

    map.eachLayer(l=>{
        if(l instanceof L.CircleMarker) map.removeLayer(l);
    });

    const date = new Date(datePicker.value);

    const hijriFull = new Intl.DateTimeFormat(
        'en-TN-u-ca-islamic',
        { day:'numeric',month:'long',year:'numeric' }
    ).format(date);

    hijriDate.innerHTML = hijriFull;

    for(let lat=25; lat<=55; lat+=3){
        for(let lon=-130; lon<=-60; lon+=3){

            const vis = classify(date,lat,lon);

            L.circleMarker([lat,lon],{
                radius: window.innerWidth < 768 ? 3 : 5,
                color:vis.color,
                fillOpacity:0.7
            }).addTo(map);
        }
    }

    sistaniBox.innerHTML =
    `<strong>According to Ayatollah Sistani:</strong><br>
     Zones A and B generally satisfy naked-eye criteria.
     Zones Câ€“E typically do not establish the month.`;
}

datePicker.addEventListener("change",update);
update();

</script>

</body>
</html>
