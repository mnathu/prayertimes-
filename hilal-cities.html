<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hilal Visibility – North America Cities</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.js"></script>

<style>
body{
  font-family:Arial, sans-serif;
  margin:0;
  background:#f5f5f5;
}
.container{
  max-width:1000px;
  margin:auto;
  padding:20px;
}
.card{
  background:white;
  padding:20px;
  border-radius:8px;
  margin-bottom:20px;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
}
h1,h2,h3{
  margin-top:0;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  text-align:center;
  border-bottom:1px solid #ddd;
}
.green{background:#d4edda;}
.yellow{background:#fff3cd;}
.red{background:#f8d7da;}
.nav-button{
  display:inline-block;
  padding:10px 18px;
  background:#0b5ed7;
  color:white;
  text-decoration:none;
  border-radius:6px;
  font-weight:600;
}
.nav-button:hover{background:#084298;}
.badge{
  padding:6px 10px;
  border-radius:6px;
  font-weight:600;
}
</style>
</head>

<body>

<div class="container">

<h1>North America Hilal Visibility Table</h1>

<div class="card">
  <label>Select Date (Gregorian): </label>
  <input type="date" id="dateInput">
  <p><strong>Hijri Date:</strong> <span id="hijriDisplay"></span></p>
</div>

<div class="card">
  <h2>Major Cities</h2>
  <table id="cityTable">
    <thead>
      <tr>
        <th>City</th>
        <th>Yallop</th>
        <th>Odeh</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="card">
  <h2>Your Location Visibility</h2>
  <div id="userVisibility"></div>
</div>

<div class="card">
  <h2>According to Sistani</h2>
  <div id="sistaniBox"></div>
</div>

<div style="text-align:center;">
  <a href="hilal-forecast.html" class="nav-button">
    ← Back to Global Forecast Map
  </a>
</div>

</div>

<script>

// ===== Major Cities Dataset =====
const cities = [
  {name:"New York", lat:40.7128, lon:-74.0060},
  {name:"Chicago", lat:41.8781, lon:-87.6298},
  {name:"Houston", lat:29.7604, lon:-95.3698},
  {name:"Los Angeles", lat:34.0522, lon:-118.2437},
  {name:"Toronto", lat:43.6532, lon:-79.3832},
  {name:"Vancouver", lat:49.2827, lon:-123.1207},
  {name:"Mexico City", lat:19.4326, lon:-99.1332}
];

// ===== Auto Default to Next 29th Hijri =====
function getNext29thHijri() {
  const today = new Date();
  const hijri = new Intl.DateTimeFormat('en-TN-u-ca-islamic', {
    day:'numeric', month:'numeric', year:'numeric'
  }).formatToParts(today);

  const day = parseInt(hijri.find(p=>p.type==="day").value);

  if(day <= 29){
    const diff = 29 - day;
    today.setDate(today.getDate() + diff);
  }else{
    today.setMonth(today.getMonth()+1);
  }

  return today;
}

const dateInput = document.getElementById("dateInput");
const defaultDate = getNext29thHijri();
dateInput.valueAsDate = defaultDate;

updateHijriDisplay(defaultDate);
runCalculations(defaultDate);

// Auto run on change
dateInput.addEventListener("change",()=>{
  const selected = new Date(dateInput.value);
  updateHijriDisplay(selected);
  runCalculations(selected);
});

// ===== Hijri Display =====
function updateHijriDisplay(date){
  const hijri = new Intl.DateTimeFormat('en-TN-u-ca-islamic',{
    day:'numeric', month:'long', year:'numeric'
  }).format(date);
  document.getElementById("hijriDisplay").innerText = hijri;
}

// ===== Yallop Model =====
function yallopVisibility(date, lat, lon){
  const sunset = SunCalc.getTimes(date, lat, lon).sunset;
  const moonPos = SunCalc.getMoonPosition(sunset, lat, lon);
  const moonIllum = SunCalc.getMoonIllumination(date);

  const altitude = moonPos.altitude * 180/Math.PI;
  const elongation = moonIllum.phase * 360;

  const q = altitude - (11 + 0.5 * elongation);

  if(q > 0.216) return {text:"Easily Visible", class:"green"};
  if(q > -0.014) return {text:"Visible under perfect conditions", class:"green"};
  if(q > -0.160) return {text:"Optical Aid Needed", class:"yellow"};
  if(q > -0.232) return {text:"Will Need Telescope", class:"yellow"};
  return {text:"Not Visible", class:"red"};
}

// ===== Odeh Model =====
function odehVisibility(date, lat, lon){
  const sunset = SunCalc.getTimes(date, lat, lon).sunset;
  const moonPos = SunCalc.getMoonPosition(sunset, lat, lon);

  const altitude = moonPos.altitude * 180/Math.PI;

  if(altitude > 8) return {text:"Naked Eye Possible", class:"green"};
  if(altitude > 5) return {text:"Possible with Optical Aid", class:"yellow"};
  return {text:"Not Visible", class:"red"};
}

// ===== Main Calculation =====
function runCalculations(date){

  const tbody = document.querySelector("#cityTable tbody");
  tbody.innerHTML = "";

  let greenCount=0, yellowCount=0, redCount=0;

  cities.forEach(city=>{
    const y = yallopVisibility(date, city.lat, city.lon);
    const o = odehVisibility(date, city.lat, city.lon);

    const tr = document.createElement("tr");

    const worstClass = (y.class==="red"||o.class==="red")?"red":
                       (y.class==="yellow"||o.class==="yellow")?"yellow":"green";

    tr.className = worstClass;

    tr.innerHTML = `
      <td>${city.name}</td>
      <td>${y.text}</td>
      <td>${o.text}</td>
    `;
    tbody.appendChild(tr);

    if(worstClass==="green") greenCount++;
    if(worstClass==="yellow") yellowCount++;
    if(worstClass==="red") redCount++;
  });

  generateSistaniComment(greenCount, yellowCount, redCount, date);

  // User location
  navigator.geolocation.getCurrentPosition(pos=>{
    const y = yallopVisibility(date, pos.coords.latitude, pos.coords.longitude);
    const o = odehVisibility(date, pos.coords.latitude, pos.coords.longitude);

    document.getElementById("userVisibility").innerHTML =
      `<div class="badge ${y.class}">
         Yallop: ${y.text} <br>
         Odeh: ${o.text}
       </div>`;
  });

}

// ===== Sistani Interpretation =====
function generateSistaniComment(green,yellow,red,date){

  let verdict="";
  let color="";

  if(green >= 3){
    verdict="Crescent likely visible within shared horizon zone.";
    color="green";
  }else if(yellow >= 3){
    verdict="Crescent marginal. Visibility may require optical aid.";
    color="yellow";
  }else{
    verdict="Crescent unlikely visible across most of North America.";
    color="red";
  }

  document.getElementById("sistaniBox").innerHTML =
    `<div class="badge ${color}">
       ${verdict}
     </div>`;
}

</script>

</body>
</html>
