<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hilal Cities Visibility</title>
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

<style>
body { font-family: Arial; background:#f4f4f4; padding:20px; }
h2 { text-align:center; }
table {
width:100%;
border-collapse:collapse;
background:white;
}
th, td {
padding:10px;
border:1px solid #ccc;
text-align:center;
}
th { background:#222; color:white; }
.good { color:green; font-weight:bold; }
.mid { color:orange; font-weight:bold; }
.bad { color:red; font-weight:bold; }
a { text-decoration:none; color:#0066cc; }
</style>
</head>
<body>

<h2>Major North American Cities</h2>

<input type="date" id="datePicker">
<br><br>

<a href="hilal-forecast.html">‚Üê Back to Map</a>

<br><br>

<table>
<thead>
<tr>
<th>City</th>
<th>Visibility</th>
</tr>
</thead>
<tbody id="cityTable"></tbody>
</table>

<script>

// Default date same as map
const today = new Date();
today.setDate(today.getDate()+29);
document.getElementById("datePicker").valueAsDate = today;

// ===== TRUE ELONGATION =====
function getElongation(date, lat, lon){

    const sunPos = SunCalc.getPosition(date, lat, lon);
    const moonPos = SunCalc.getMoonPosition(date, lat, lon);

    const cosE =
        Math.sin(sunPos.altitude)*Math.sin(moonPos.altitude) +
        Math.cos(sunPos.altitude)*Math.cos(moonPos.altitude)*
        Math.cos(sunPos.azimuth - moonPos.azimuth);

    return Math.acos(cosE) * (180/Math.PI);
}

// ===== SAME ENGINE =====
function classifyVisibility(date, lat, lon){

    const times = SunCalc.getTimes(date, lat, lon);
    const sunset = new Date(times.sunset.getTime() + 5*60000);

    const sunPos = SunCalc.getPosition(sunset, lat, lon);
    const moonPos = SunCalc.getMoonPosition(sunset, lat, lon);

    const moonAlt = moonPos.altitude * 180/Math.PI;
    const sunAlt  = sunPos.altitude * 180/Math.PI;

    const elong = getElongation(sunset, lat, lon);

    const arcv = moonAlt - sunAlt;
    const arcl = elong;

    const q = arcv - (0.1018*arcl*arcl - 1.162*arcl + 6.322);

    if(q > 0.216)
        return {zone:"A", color:"green", text:"üü¢ Easily Visible"};
    else if(q > -0.014)
        return {zone:"B", color:"lightgreen", text:"üü¢ Visible under perfect conditions"};
    else if(q > -0.160)
        return {zone:"C", color:"orange", text:"üü° Optical aid required"};
    else if(q > -0.232)
        return {zone:"D", color:"darkorange", text:"üü† Very difficult"};
    else
        return {zone:"E", color:"red", text:"üî¥ Not Visible"};
}

const cities = [
{ name:"New York", lat:40.71, lon:-74.00 },
{ name:"Chicago", lat:41.88, lon:-87.63 },
{ name:"Houston", lat:29.76, lon:-95.37 },
{ name:"Los Angeles", lat:34.05, lon:-118.24 },
{ name:"Toronto", lat:43.65, lon:-79.38 },
{ name:"Vancouver", lat:49.28, lon:-123.12 },
{ name:"Mexico City", lat:19.43, lon:-99.13 }
];

function updateTable(){

    const date = new Date(document.getElementById("datePicker").value);
    const table = document.getElementById("cityTable");
    table.innerHTML = "";

    cities.forEach(city=>{
        const vis = classifyVisibility(date, city.lat, city.lon);
        if(!vis) return;

        const row = `<tr>
            <td>${city.name}</td>
            <td class="${vis.zone}">${vis.text}</td>
        </tr>`;

        table.innerHTML += row;
    });
}

document.getElementById("datePicker").addEventListener("change",updateTable);
updateTable();

</script>

</body>
</html>
